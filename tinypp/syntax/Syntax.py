from syntax.Tree import *
from syntax.TokensHelper import *
import json
import os
import ntpath
################### ENDPOINTS
_tipo = ["int","float","boolean"]
_sentencia = ["if","while","do","cin","cout","{"]
_relacion = ["<=", "<", ">" ,">=", "==", "!="]
_suma_op = ["+","-"]
_mult_op = ["*","/"]
#############################
_gramatica = {"programa":[[ "main","{","lista-sentencias","}" ]],
			"lista-declaracion":[ ["declaracion",";","lista-declaracion"],["$"] ],
			"declaracion":[["tipo","lista-variables"]],
			"tipo":[ ["int"],["float"],["boolean"]],
			"lista-variables":[["identificador",",","lista-variables"],["identificador"]],
			"lista-sentencias":[["sentencia","lista-sentencias"],["sentencia"],["$"]],
			"sentencia":[["seleccion"],["iteracion"],["repeticion"],["sent-cin"],["sent-cout"],["bloque"],["asignacion"]],
			"seleccion":[["if","(","expresion",")","then","bloque"],["if","(","expresion",")","then","bloque","else","bloque"]],
			"iteracion":[["while","(","expresion",")","bloque"]],
			"repeticion":[["do","bloque","until","(","expresion",")",";"]],
			"sent-cin":[["cin","identificador",";"]],
			"sent-cout":[["cout","expresion",";"]],
			"bloque":[["{","lista-sentencias","}"]],
			"asignacion":[["identificador",":=","expresion",";"]],
			"expresion":[["expresion-simple","relacion","expresion-simple"],["expresion-simple"]],
			"relacion":[["<="],["<"],[">"],[">="],["="],["!="]],
			"expresion-simple":[["expresion-simple","suma-op","termino"],["termino"]],
			"suma-op":[["+"],["-"]],
			"termino":[["termino","mult-op","factor"],["factor"]],
			"mult-op":[["*"],["/"]],
			"factor":[["(","expresion",")"],["numero"],["identificador"]]						
			}

#############################
def isTerminal(X):
	_isTerminal = False
	try:
		_gramatica[X]
	except:
		_isTerminal = True
	return _isTerminal

def primero(X,cambio=None):
	if isTerminal(X):
		return [X]
	elif X == cambio:
		conjunto = []
		Y = _gramatica[X]
		conjunto = list(set(conjunto).union( primero(Y[0][1],X) ))
	else:		
		conjunto = []
		Y = _gramatica[X]
		for x in Y:
			conjunto = list(set(conjunto).union( primero(x[0],X) ))
	return conjunto

class Syntax:
	#programa → main “{“ lista-declaración lista-sentencias “}”
	def programa(self):
		#self.tokensHelper.cliDisplayTokens()
		firstToken = self.tokensHelper.getToken()	
		self.tokensHelper.match("main")
		self.root = Node(firstToken.content)
		self.tokensHelper.match("{")
		self.root.addChild( self.lista_declaracion() )
		self.root.addChild( self.lista_sentencias() )
		self.tokensHelper.match("}")
		#print("INFO: Syntax Compilation finished. Tree:")
		#TreeUtils.cliDisplay(root)
		if self.outputType == "json":
			print(json.dumps(self.root.__dict__, indent=4, sort_keys=False))
		elif self.outputType == "tree":
			TreeUtils.cliDisplay(self.root)
		elif self.outputType == "none":
			print("== No output ==")
		else:
			print("Invalid argument: "+self.outputType)
	#lista-declaración -> { declaración; }
	def lista_declaracion(self):
		decl = None
		while self.tokensHelper.getCurrentToken().content in _tipo:
			if decl == None:
				decl = self.declaracion()
			else:
				decl.appendBro( self.declaracion() )
			self.tokensHelper.match(";")
		
		if decl != None and len(decl.sons) > 0:
			return decl
		else:
			return None

	#lista-sentencias → { sentencia }
	#sentencia → selección | iteración | repetición | sent-cin |sent-out | bloque | asignación
	def lista_sentencias(self):
		tmp = new = None
		while self.tokensHelper.getCurrentToken().content in _sentencia or self.tokensHelper.getCurrentToken().type == TokenConstants.ID:
			if self.tokensHelper.getCurrentToken().content == TokenConstants.IF:
				new = self.seleccion()
			elif self.tokensHelper.getCurrentToken().content == TokenConstants.WHILE:
				new = self.iteracion()
			elif self.tokensHelper.getCurrentToken().content == TokenConstants.DO:
				new = self.repeticion()
			elif self.tokensHelper.getCurrentToken().content == TokenConstants.CIN:
				new = self.sent_cin()
			elif self.tokensHelper.getCurrentToken().content == TokenConstants.COUT:
				new = self.sent_cout()
			elif self.tokensHelper.getCurrentToken().content == TokenConstants.BRACKET_OPEN:
				new = self.bloque()
			elif self.tokensHelper.getCurrentToken().type == TokenConstants.ID:
				new = self.asignacion()
			
			if tmp == None:
				tmp = new
			else:
				tmp.appendBro( new )
		if tmp != None and len(tmp.sons) > 0:
			return tmp
		else:
			return None
			
	#selección → if ( expresión ) then bloque | if ( expresión ) then bloque else bloque
	def seleccion(self):
		ifStmt = Node( TokenConstants.IF )
		self.tokensHelper.match( TokenConstants.IF )
		self.tokensHelper.match( "(" )
		ifStmt.addChild ( self.expresion() )
		self.tokensHelper.match( ")" )
		self.tokensHelper.match( "then" )
		ifStmt.addChild( self.bloque() )

		if( self.tokensHelper.getCurrentToken().content == TokenConstants.ELSE ):
			self.tokensHelper.match( TokenConstants.ELSE )
			ifStmt.addChild( self.bloque() )
			
		return ifStmt
		
	#expresión → expresión-simple { relación expresión-simple }
	def expresion(self):
		exp = None
		tmp = self.expresion_simple()
		if( self.tokensHelper.getCurrentToken().content in _relacion ):
			exp = self.relacion()
			exp.addChild(tmp)
			exp.addChild( self.expresion_simple() )
		if exp == None:
			exp = tmp
		return exp

	def relacion(self):
		rel = self.tokensHelper.getCurrentToken().content
		self.tokensHelper.match(TokenConstants.RELATION,True)
		return Node(rel)

	#expresión-simple → termino { suma-op termino }
	def expresion_simple(self):
		tmp = self.termino()
		while( self.tokensHelper.getCurrentToken().content[0] in _suma_op):
			new = self.suma_op()
			new.addChild(tmp)
			comesFromALess = self.tokensHelper.getCurrentToken().content[0]=="-"
			term = self.termino(comesFromALess)
			#new.addChild( termino() )
			#Here we're validating if the operation symbol is less and
			#the second number of the operation is a negative number
			if new != None and term != None and new.name == "-" and term.name[0] == "-":
				#remove the negative number
				term.name = term.name[1:]
			new.addChild( term )
			tmp = new
		return tmp

	def suma_op(self):
		rel = self.tokensHelper.getCurrentToken().content[0]
		if(self.tokensHelper.getCurrentToken().type == TokenConstants.PLUS):
			self.tokensHelper.match(TokenConstants.PLUS,True)
		elif (self.tokensHelper.getCurrentToken().type == TokenConstants.LESS):
			self.tokensHelper.match(TokenConstants.LESS,True)
		return Node(rel)

	#termino → factor { mult-op factor }
	def termino(self,comesFromALess=False):
		tmp = self.factor()
		#Verify if the parent is a less
		#and check if the number is a negative number
		#if comesFromALess and tmp.name[0] == "-":
		#	tmp.name = tmp.name[1:]
	
		while ( self.tokensHelper.getCurrentToken().content in _mult_op):
			new = self.mult_op();
			new.addChild(tmp)
			new.addChild( self.factor() )
			tmp = new
		return tmp

	def mult_op(self):
		rel = self.tokensHelper.getCurrentToken().content
		if(self.tokensHelper.getCurrentToken().content == TokenConstants.TIMES):
			self.tokensHelper.match(TokenConstants.TIMES)
		elif (self.tokensHelper.getCurrentToken().content == TokenConstants.DIV):
			self.tokensHelper.match(TokenConstants.DIV)
		return Node(rel)

	#factor → ( expresión ) | numero | identificador
	def factor(self):
		new = None
		if self.tokensHelper.getCurrentToken().content == "(":
			self.tokensHelper.match("(")
			new = self.expresion()
			self.tokensHelper.match(")")
		elif self.tokensHelper.getCurrentToken().type == TokenConstants.INT:
			new = Node(self.tokensHelper.getCurrentToken().content)
			self.tokensHelper.match(TokenConstants.INT,True)
		
		elif self.tokensHelper.getCurrentToken().type == TokenConstants.FLOAT:
			new = Node(self.tokensHelper.getCurrentToken().content)
			self.tokensHelper.match(TokenConstants.FLOAT,True)
		else:
			new = Node(self.tokensHelper.getCurrentToken().content)
			self.tokensHelper.match(TokenConstants.ID,True)

		return new

	#iteración → while ( expresión ) bloque
	def iteracion(self):
		new = Node( TokenConstants.WHILE )
		self.tokensHelper.match( TokenConstants.WHILE )
		self.tokensHelper.match("(")
		new.addChild( self.expresion() )
		self.tokensHelper.match(")")
		new.addChild( self.bloque() )
		return new

	#repetición → do bloque until ( expresión ) ;
	def repeticion(self):
		new = Node( TokenConstants.DO )
		self.tokensHelper.match( TokenConstants.DO )
		new.addChild( self.bloque() )
		self.tokensHelper.match("until")
		self.tokensHelper.match("(")
		new.addChild( self.expresion() )
		self.tokensHelper.match(")")
		self.tokensHelper.match(";")
		return new


	#sent-cin → cin identificador ;
	def sent_cin(self):
		new = Node("cin")
		self.tokensHelper.match("cin")
		new.addChild( Node(self.tokensHelper.getCurrentToken().content ) )
		self.tokensHelper.match(TokenConstants.ID,True)
		self.tokensHelper.match(";")	
		return new

	#sent-cout → cout expresión ;
	def sent_cout(self):	
		new = Node("cout")
		self.tokensHelper.match("cout")
		exp = self.expresion()
		new.addChild( exp ) 
		self.tokensHelper.match(";")	
		return new

	def bloque(self):
		self.tokensHelper.match("{")
		new = self.lista_sentencias()
		self.tokensHelper.match("}")
		return new

	#asignación → identificador := expresión ;
	def asignacion(self):
		new = Node(":=")
		ide = Node(self.tokensHelper.getCurrentToken().content)
		new.addChild(ide)
		self.tokensHelper.match(TokenConstants.ID,True)
		if self.tokensHelper.getCurrentToken().type == TokenConstants.INCREMENT:
			plusNode = Node("+")
			plusNode.addChild( ide )
			self.tokensHelper.match(TokenConstants.INCREMENT,True)
			plusNode.addChild(Node("1"))
			new.addChild(plusNode)	
		elif self.tokensHelper.getCurrentToken().type == TokenConstants.DECREMENT:
			lessNode = Node("-")
			lessNode.addChild( ide )
			self.tokensHelper.match(TokenConstants.DECREMENT,True)
			lessNode.addChild(Node("1"))
			new.addChild(lessNode)
		else:
			self.tokensHelper.match(":=")
			asignExp = self.expresion()
			new.addChild( asignExp )
		self.tokensHelper.match(";")
		return new

	#declaración → tipo lista-variables
	def declaracion(self):
		tmp = Node(self.tokensHelper.getCurrentToken().content)
		self.tokensHelper.match(TokenConstants.ID,True)
		self.lista_variables(tmp)
		return tmp

	#lista-variables → { identificador, } identificador
	def lista_variables(self,parent):
		parent.addChild(Node(self.tokensHelper.getCurrentToken().content))
		self.tokensHelper.match(TokenConstants.ID,True)

		while self.tokensHelper.getCurrentToken().content == ",":
			self.tokensHelper.match(",")
			parent.addChild(Node(self.tokensHelper.getCurrentToken().content))
			self.tokensHelper.match(TokenConstants.ID,True)


	def __init__(self,pathOfSouce,outputType="json"):
		canonicalFileName = ntpath.basename(pathOfSouce)
		withoutExtention = canonicalFileName[0:canonicalFileName.find(".")]
		lexDirectory = "target_"+withoutExtention+"\\lex\\"
		basepath = ntpath.abspath(pathOfSouce)[0:len(ntpath.abspath(pathOfSouce))-len(canonicalFileName)]
		arg = basepath+lexDirectory+"out.lex"	
		if not os.path.exists(arg):
			basepath = basepath.replace("\\","/")
			arg = basepath+"out.lex"
			if not os.path.exists(arg):
				arg = basepath+lexDirectory+"out.lex"	
				arg = arg.replace("\\","/")
				if not os.path.exists(arg):
					print("Error, analisis lexico aun no ejecutado",file=sys.stderr)
					exit(1)
		self.tokensHelper = TokensHelper(arg)
		self.outputType = outputType
	def go(self):
		self.programa()
